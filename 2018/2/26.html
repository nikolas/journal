<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>
            MediaWiki's Visual Editor, and text editing on the web in general
        </title>
        <meta name="author" content="Nik Nyby">
        <link href="https://fonts.googleapis.com/css?family=Lora:400,700" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="../../journal.css" type="text/css" />
        <style type="text/css">
            figcaption {
            padding: 1px 6px;
            border-left: 4px solid #333;
            }

            article img {
            max-width: 100%;
            }
        </style>
    </head>
    <body>

    <article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="name">
            MediaWiki's Visual Editor, and text editing on the web in general
        </h1>
        <div style="display: none;" itemprop="author">Nik Nyby</div>
        <time datetime="2018-02-26" itemprop="datePublished">Monday, February 26, 2018</time>
    </header>

    <div itemprop="articleBody">
        <p>
            Editing and formatting text on the web comprises of an
            interesting sub-field of web development. The web allows
            for different ways to turn text into HTML markup. First
            I'll outline some of the background of interactive text
            formatting on the web from my perspective, and then go
            into some configuration details of MediaWiki's Visual
            Editor that I found interesting.
        </p>
        <p>
            Libraries like
            <a href="https://www.mathjax.org/">MathJax</a> allow for
            LaTeX-style math syntax to be meticulously, accurately
            rendered with
            SVG. User-facing <a href="https://en.wikipedia.org/wiki/WYSIWYG">WYSIWYG</a>
            editors like <a href="https://yabwe.github.io/medium-editor/">medium-editor</a>
            and
            <a href="https://github.com/nikolas/markdown-toolbar#markdown-toolbar">markdown-toolbar</a>
            give users a small toolbar with a few formatting options. markdown-toolbar
            adheres to the <a href="http://commonmark.org/">CommonMark</a> spec, allowing
            for the HTML transformation to happen either server-side or client-side, 
            yielding identical results in both cases.
        </p>
        <figure>
            <img src="i/mathjax.png" alt="MathJax">
            <figcaption>MathJax</figcaption>
        </figure>
        <figure>
            <img src="i/medium.png" alt="medium.com editor">
            <figcaption>medium.com's editor</figcaption>
        </figure>
        <figure>
            <img src="i/markdown-toolbar.png" alt="markdown-toolbar">
            <figcaption>markdown-toolbar</figcaption>
        </figure>
        <p>
            At the next level, libraries like
            <a href="https://ckeditor.com/">CKEditor</a> and
            <a href="https://www.tinymce.com/">TinyMCE</a>, originally
            developed in the 2000s and inspired by word processors
            like MS Word, allow for an unending amount of layout
            features. If something is missing, you can just make a new
            plugin and attach it to the toolbar. These editors often
            have a "View Source" button that allows you to edit the
            HTML that's being generated by the editor's JavaScript
            code. And that's where the more pedantic web developers
            bring up the fact that, at the end of the day, you still
            need to know HTML and CSS to reallya lay out text and
            images on the web with the kind of flexibility, because
            doing this is in an automated way just makes a mess. There
            are too many undefined cases in the interactions between
            all the different plugins and layout options for the
            developers to be able to handle it all, and put it in a
            DOM structure that makes sense. Word processors don't have
            this problem because they control the entire rendering
            process and don't have to deal with web standards.
        </p>
        <figure>
            <img src="i/tinymce.png" alt="TinyMCE">
            <figcaption>TinyMCE</figcaption>
        </figure>
        <figure>
            <img src="i/ckeditor.png" alt="ckeditor">
            <figcaption>CKEditor</figcaption>
        </figure>
        <p>
            Wikipedia started in 2001, and its content survives today
            in its original form of custom "wiki" markup, complete
            with a stable transformation to HTML. Its underlying
            software, which turned into a project called MediaWiki,
            handles the wikitext-to-HTML transformation with a script
            known
            as <a href="https://www.mediawiki.org/wiki/Parsing">the
            PHP parser</a>.  Until a few years ago, anyone editing
            Wikipedia was expected just to deal with the wikitext
            syntax. It's similar to Markdown, and not that bad for making
            small edits. But, this did discourage people who didn't
            want to learn this from writing longer articles from
            scratch. And as the 2010s arrived, it became obvious
            that there were improvements that could be made. So
            the <a href="https://www.mediawiki.org/wiki/VisualEditor">VisualEditor</a>
            project started.
        </p>
        <p>
            The MediaWiki developers didn't have the luxury of a
            well-defined markup language like CommonMark. We are able
            to leverage that in
            <a href="https://github.com/ccnmtl/dmt">the PMT</a>, and I
            imagine that if MediaWiki took some cues here, they might
            be able to simplify the VisualEditor process by removing
            the dependency on their node.js service
            (called <a href="https://www.mediawiki.org/wiki/Parsoid">Parsoid</a>),
            that translates HTML into wiki markup. I haven't dug
            deeper, though, and it's possible that wikitext is just
            too complicated, or the scope of the problem is bigger
            than what I'm seeing.
        </p>
        <p>
            I don't really know the specifics of Parsoid, but you can
            read about its design
            <a href="https://blog.wikimedia.org/2013/03/04/parsoid-how-wikipedia-catches-up-with-the-web/">here</a>.
            From my understanding, it uses MediaWiki's API to fetch
            pages and give them to the VisualEditor in the client's
            browser via XHR.  I was hesitant to even set it up,
            because that's a pretty big change in how edits happen
            in the wiki.
        </p>
        <p>
            I wouldn't have been able to get things working without
            <a href="https://www.mediawiki.org/wiki/Parsoid/Troubleshooting">Parsoid's
            Troubleshooting page</a>.  Through my test curl requests,
            I was able to debug about three hurdles I ran into.
            First, our wiki is private, so Parsoid needed to be
            authenticated somehow, for read access to the pages.
            Fortunately, using Parsoid on private wikis is
            <a href="https://www.mediawiki.org/wiki/Extension:VisualEditor#Linking_with_Parsoid_in_private_wikis">documented</a>,
            and I was able to allow Parsoid's access by whitelisting a
            specific user's access if the request comes from
            localhost, using
            the <a href="https://www.mediawiki.org/wiki/Extension:NetworkAuth">NetworkAuth</a>
            extension.  This solution seemed simpler and less sketchy to me than
            the first documented solution: forwarding the user's
            cookies to Parsoid.  I also needed to change Parsoid's default
            configuration for the path to MediaWiki's api.php,
            and also to request the wiki's actual name instead
            of <code>localhost</code>, so that nginx resolves the name
            correctly.  Note that this all happens on localhost, which
            is also within a private network and behind a proxy
            server, so these requests don't need to happen over HTTPS.
            Which is pretty fortunate, because allowing Parsoid to
            make HTTPS requests requires another service called
            <a href="https://www.mediawiki.org/wiki/Extension:VisualEditor#Parsoid_over_HTTPS">stunnel</a>,
            and some additional setup with certs.
        </p>
        <figure>
            <img src="i/visual-editor.png" alt="MediaWiki's Visual editor">
            <figcaption>MediaWiki's Visual Editor</figcaption>
        </figure>
        <p>
            The end result is that the Visual Editor looks really nice. 
            And, personally I still expect to use the "Edit source" button
            a lot to make quick edits, just cause I'm so used to it, and it's
            faster. The Visual Editor takes a few seconds to load.
            It will be interesting to see if this actually makes things easier for
            users, and if there is much of an added burden on maintenance as I
            make periodic updates to MediaWiki and Parsoid.
        </p>
    </div>
  </article>

  <footer>
      <a href="../../" title="Back">&larr;</a>
  </footer>
</body>
</html>
